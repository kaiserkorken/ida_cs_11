---
title: "Documentation"
author: "Group 11"
output: html_document:
          toc: TRUE
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Importing the data

## Data preparation

## Creation of the final data set

Now the created tables will be merged to create the final data set. For this the table "fz_zu_komp" is joined by an inner-join operation with "komp_zu_teile_werk" by the "ID_Komponente" to "fz_komp_teile". Then "fz_komp_teile" is again joined by an inner-join operation with the table "zulassung", where the value of the column "ID_Fahrzeug" corresponds to the value of the column "IDNummer". 

```{r}
# join Fahrzeug->Komponente and Komponente->Einzelteil table
names(fz_zu_komp)<-gsub("Werksnummer","Werksnummer_Fahrzeug",names(fz_zu_komp))
fz_komp_teile <- fz_zu_komp %>%
	inner_join(komp_zu_teile_werk,by="ID_Komponente")
fz_komp_teile$Werksnummer_Einzelteil<-as.double(fz_komp_teile$Werksnummer_Einzelteil)
fz_komp_teile_zul <- fz_komp_teile %>%
  inner_join(zulassung,by=c("ID_Fahrzeug" = "IDNummer"))#%>%
```

To add the geodata as well, they are merged with the just created table "fz_komp_teile_zul" by performing several inner-join operations through the tables "geodata", "gemeinde_geo" and "geo_state_city". The data of "geodata" is added by matching the rows containing the value of the plant in "Werksnummer_Fahrzeug", "Werksnummer_Komponente" and "Werksnummer_Einzelteil". The inner-join operation by "gemeinde_geo" and "geo_state_city" matches the rows of the tables which have the same entry as municipality.

```{r}
# join geodata (for vehicles and component manufacturer
fz_komp_teile_geo <- fz_komp_teile_zul %>%
	inner_join(geodata, by=c(Werksnummer_Fahrzeug="Werk")) %>%
	inner_join(geodata, by=c(Werksnummer_Komponente="Werk"), suffix=c("", "_Komponente"))%>%
  inner_join(geodata, by=c(Werksnummer_Einzelteil="Werk"), suffix=c("", "_Einzelteil"))%>%
  inner_join(gemeinde_geo, by=c("Gemeinden" = "Gemeinde"), suffix=c("_Fahrzeug",""))%>%
  inner_join(geo_state_city, by=c("Gemeinden"="Gemeinde"), suffix=c("_Gemeinde","_Hauptstadt"))
```

Finally, the last table "fz_komp_teile_geo_dist" is created by calculating the distance between a single part and a component, the distance between a component and a vehicle, from a vehicle to a capital city and from a capital city to a municipality by applying the function "calc_distance_in_km" to the geodata, respectively taking the longitude and latitude of each single part, component, vehicle, capital city and municipality as position. This generated table will then be used as the final dataset and a .csv-data is created with the name "Final_Data_Group_11.csv".

```{r}
# calculate distances of material flow
fz_komp_teile_geo_dist <- fz_komp_teile_geo %>%
  mutate(Distanz_Einzelteil_zu_Komponente_in_km = calc_distance_in_km(Längengrad_Einzelteil, Breitengrad_Einzelteil, Längengrad_Komponente, Breitengrad_Komponente)) %>%
  mutate(Distanz_Komponente_zu_Fahrzeug_in_km = calc_distance_in_km(Längengrad_Komponente, Breitengrad_Komponente, Längengrad_Fahrzeug, Breitengrad_Fahrzeug)) %>%
  mutate(Distanz_Fahrzeug_zu_Hauptstadt_in_km = calc_distance_in_km(Längengrad_Fahrzeug, Breitengrad_Fahrzeug, Längengrad_Hauptstadt, Breitengrad_Hauptstadt))%>%
  mutate(Distanz_Hauptstadt_zu_Gemeinde_in_km = calc_distance_in_km(Längengrad_Hauptstadt, Breitengrad_Hauptstadt, Längengrad_Gemeinde, Breitengrad_Gemeinde ))
summary(fz_komp_teile_geo)

fwrite(fz_komp_teile_geo_dist,file=paste0(getwd(),"/Final_Data_Group_11.csv"), row.names = FALSE)
```

### calculating positions and distances

The positions of each municipality and location were determined on the map, and a filter was applied to the shape of the map, making only the positions of the used locations visible. The used locations can be found in the filter variables "e_filt", "k_filt", "f_filt", "s_filt" and "g_filt" and are used to hide the locations of the shape file of the map, which do not appear in the filter variables.

```{r}
e_filt <- st_as_sf(single_part_label, coords = c("Längengrad","Breitengrad"), crs=4326)
     k_filt <- st_as_sf(component_label, coords = c("Längengrad","Breitengrad"), crs=4326)
     f_filt <- st_as_sf(vehicle_label, coords = c("Längengrad","Breitengrad"), crs=4326)
     s_filt <- st_as_sf(state_capital_label, coords = c("Längengrad","Breitengrad"), crs=4326)
     g_filt <- st_as_sf(gemeinde_label, coords = c("Längengrad","Breitengrad"), crs=4326)
     
     map_germany<-map_germany + 
       tm_shape(e_filt)+tm_dots(col = "red",
                                scale =2,
                                border.col = "black",
                                labels="Single-Part-Supplier",
                                id="ORT",
                                popup.vars = c("Type:" = "Typ", "Serial number:" = "ID","Factory plant:"="Werksnummer"),
                                title = "Legened:")+
       tm_shape(k_filt)+tm_dots(col = "yellow",
                                scale =2,
                                border.col = "black",
                                labels="Component-Supplier",
                                id="ORT",
                                popup.vars = c("Type:" = "Typ", "Serial number:" = "ID","Factory plant:"="Werksnummer","Distance from SPS to CS in km:"="Distanz_Einzelteil_zu_in_km"),
                                title = "Legened:")+
       tm_shape(f_filt)+tm_dots(col = "blue",
                                scale =2,
                                border.col = "black",
                                labels="OEM1 Factory",
                                id="ORT",
                                popup.vars = c( "OEM1 Factory:" = "Werksnummer", "Vehicle ID:" ="ID", "Distance from CS to OEM1 in km:"="Distanz_Komponente_zu_in_km"),
                                title = "Legened:")+
       tm_shape(s_filt)+tm_dots(col = "green",
                                scale =2,
                                border.col = "black",
                                id="Hauptstadt",
                                popup.vars = c("Distance from OEM1 to State Capital in km:"="Distanz_Fahrzeug_zu_in_km"),
                                labels="Distribution Center")+
       tm_shape(g_filt)+tm_dots(col = "orange",
                                scale =2,
                                border.col = "black",
                                id="Gemeinden",
                                popup.vars = c("Distance from State Capital to State of Customer in km:"="Distanz_Hauptstadt_zu_in_km","Distance overall in km:"="gesamtDistanz"),
                                labels="State of Customer")
```

Since the positions of the different sites are given in longitude and latitude in degrees, the distance between two points can not be calculated with the cartesian distance in cartesian coordinates. For this reason the there is a function which calculates the distance between two points using a haversine curve and casts it to a integer in kilometres.

```{r}

# calculate shortest distances between points A and B given by longitude and latitude in degrees to km via Haversine
calc_distance_in_km <- function(lonA, latA, lonB, latB) {
  as.integer(distHaversine(cbind(lonA,latA),cbind(lonB,latB)))/1000
}
# example:
calc_distance_in_km(52, 13, 50, 7)
```

This function is then used on the plants for single parts, components, OEM, State capital and Distribution center, and gets also added to the final data set.

```{r}
# calculate distances of material flow

fz_komp_teile_geo_dist <- fz_komp_teile_geo %>%
  mutate(Distanz_Einzelteil_zu_Komponente_in_km = calc_distance_in_km(Längengrad_Einzelteil, Breitengrad_Einzelteil, Längengrad_Komponente, Breitengrad_Komponente)) %>%
  mutate(Distanz_Komponente_zu_Fahrzeug_in_km = calc_distance_in_km(Längengrad_Komponente, Breitengrad_Komponente, Längengrad_Fahrzeug, Breitengrad_Fahrzeug)) %>%
  mutate(Distanz_Fahrzeug_zu_Hauptstadt_in_km = calc_distance_in_km(Längengrad_Fahrzeug, Breitengrad_Fahrzeug, Längengrad_Hauptstadt, Breitengrad_Hauptstadt))%>%
  mutate(Distanz_Hauptstadt_zu_Gemeinde_in_km = calc_distance_in_km(Längengrad_Hauptstadt, Breitengrad_Hauptstadt, Längengrad_Gemeinde, Breitengrad_Gemeinde ))

```


The final data set can now be viewed and saved as a .csv-file for later use in the shiny app:

```{r}
summary(fz_komp_teile_geo)
fwrite(fz_komp_teile_geo_dist,file=paste0(getwd(),"/Final_Data_Group_11.csv"), row.names = FALSE)
```



## Evaluation



The finished data set can now be saved as well as loaded.

```{r}
source("Case_Study_App_load_data.R")
```


### Visualisation of material flow

For evaluation of the data it is helpful to visualize data in different ways. In the case study were different types of plots developed for the given data. They show information about the distribution chain and material flow of the different levels of car manufacturing.

#### Map

To visualize the complex distribution chain of car manufacturing a map with a connection graph can be helpful. The map shows Germany and can plot all involved points in germany for a given vehicle ID. Furthermore the app can overlay the distribution chain of the shortest, longest or median total distance for comparison. The connections of the different levels can be turned on or off as well, if e.g. only the connection from single part plants to component plants shall be compared. Since there are different types of vehicles in the data the comparison of shortest, longest or median total distances can be enabled to only show the according paths of the same vehicle type as entered.


#### Boxplot

The boxplot shall show the material flow over the different phases of production. Before a single part gets assembled to a component it has to travel to the according component plant. In the same way, components have to travel to the OEM site, as well as the finished vehicles need to go to the state capital from which they go to the final distribution center. 

For this, the data is grouped by single parts, components and vehicle IDs and 

```{r , echo=FALSE}
boxplot_from_selected(captions_list, dist_vs_type, levels_selected=1:4) 
```

The plot shows how similar the distances between single parts and components are both in median as well as deviation. Even the median of the distances between the OEM and State capital which is about 260 km as well as its deviation is very similar. All in all however is the distance a vehicle travels to the final distribution center in median about 90 km longer. And while most cars need to travel around this median within an interval of 200km (first to third quantile), the maximum travel distance is much greater.


#### Material flow of components

In the material flow, a diagram is shown where the x-axis represents the locations of the component suppliers and the y-axis the number of components delivered from the respective supplier to the two vehicle factories in Bonn and Nuremberg. The number of components delivered to Bonn is represented by the red bars and the number of components delivered to Nuremberg by the green bars.



## Result




